<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>From Snowflake Servers to GitOps Nirvana</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="A beginner-friendly tour of the declarative stack that actually runs itself.">
  <meta name="keywords" content="GitOps,NixOS,Kubernetes,ArgoCD,Terraform,Docker,DSPy,OPA">
  <meta name="author" content="Jonathan McGuinness">
  <meta name="theme-color" content="#111827">

  <style>
    /* --- Base styles ------------------------------------------------------ */
    body {
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;
      line-height:1.6;
      margin:2rem auto;
      max-width:680px;
      padding:0 1rem;
      color:#ffffff;
      background:#111827;
    }
    h1,h2{color:#60a5fa;}
    table{width:100%;border-collapse:collapse;margin:1rem 0;}
    th,td{padding:.5rem;border:1px solid #374151;text-align:left;}
    code{background:#1f2937;padding:.15rem .35rem;border-radius:3px;}
    pre{background:#1f2937;padding:1rem;overflow-x:auto;}
    img{max-width:100%;height:auto;border-radius:6px;}
    a{color:#00ff00;}
    a:visited{color:#22c55e;}
    html{scroll-behavior:smooth;}

    /* --- Zoom-friendly SVG ------------------------------------------------ */
    .infra-svg{
      width:100%;
      height:auto;
      max-height:70vh;
      border-radius:6px;
      cursor:zoom-in;
      background:#111827;
      border:1px solid #374151;
      /* allow native pinch-zoom on touch devices */
      touch-action:manipulation;
    }
    /* dark-theme node & edge colours */
    .infra-svg .node rect,
    .infra-svg .node circle,
    .infra-svg .node polygon{
      fill:#111827;
      stroke:#60a5fa;
      stroke-width:2;
    }
    .infra-svg .edgePath .path{
      stroke:#00ff00;
      stroke-width:2;
    }

    /* --- Copy button ------------------------------------------------------ */
    #copyBtn{
      background:#00ff22;
      border:none;
      color:#111827;
      padding:.25rem .5rem;
      border-radius:4px;
      cursor:pointer;
      font-size:.9rem;
    }
  </style>
</head>

<body>
  <h1>From Snowflake Servers to GitOps Nirvana</h1>
  <p><em>A beginner-friendly tour of the declarative stack that actually runs itself — 04 Aug 2025</em></p>

  <p>You’ve probably heard the buzzwords: GitOps, NoOps, immutable infrastructure. Today I’d like to walk you—step by step—through why these concepts exist and how a small constellation of tools (<a href="https://git-scm.com/" target="_blank" rel="noopener">Git</a>, <a href="https://nixos.org/" target="_blank" rel="noopener">NixOS</a>, <a href="https://docker.com/" target="_blank" rel="noopener">Docker</a>, <a href="https://developer.hashicorp.com/terraform/" target="_blank" rel="noopener">Terraform</a>, <a href="https://kubernetes.io/" target="_blank" rel="noopener">Kubernetes</a>, <a href="https://argo-cd.readthedocs.io/en/stable/" target="_blank" rel="noopener">ArgoCD</a>, <a href="https://dspy.ai/" target="_blank" rel="noopener">DSPy</a>, and a pinch of <a href="https://www.openpolicyagent.org/" target="_blank" rel="noopener">OPA</a> policy-as-code) fit together to create a platform that deploys itself every time you hit <i>merge</i>.</p>

  <hr>

  <h2>1. The Problem We’re Solving</h2>
  <p>In the old world, a server was a pet: lovingly hand-fed config files, patched on Sundays, and inevitably different from every other server. The result?</p>
  <ul>
    <li>“It works on my machine!”</li>
    <li>Snow-flake drift and 3 a.m. pages.</li>
    <li>Scaling = more pets.</li>
  </ul>

  <hr>

  <h2>2. The North Star: Everything as Code</h2>
  <p>Instead of pets, we want cattle—identical, replaceable, and defined in text files that live in Git.</p>
  <p>If Git is the <i>single source of truth</i>, the rest of the stack becomes a conveyor belt that turns that truth into running software.</p>

  <hr>

  <h2>3. The Cast of Characters and Their Jobs</h2>
  <section>
    <h3>Reproducible Stack Cheat-Sheet</h3>
    <table>
      <thead>
        <tr><th>Tool</th><th>One-Sentence Job</th><th>Why It Matters</th></tr>
      </thead>
      <tbody>
        <tr><td><strong>Git</strong></td><td>The single source-of-truth for every line of code and config.</td><td>Immutable history + pull-requests = collaboration without chaos.</td></tr>
        <tr><td><strong>NixOS</strong></td><td>An entire Linux distro expressed in one declarative file.</td><td>Reinstalls laptop or 1 000-server fleet with <code>nixos-rebuild</code>.</td></tr>
        <tr><td><strong>Terraform</strong></td><td>Describe cloud resources (VPCs, disks, IAM) in HCL.</td><td>Re-creates an entire region from scratch in 15 min after a coffee spill.</td></tr>
        <tr><td><strong>Docker</strong></td><td>Bundle the app and its libraries into an immutable image.</td><td>Same artifact runs on your Mac, in CI, and in prod.</td></tr>
        <tr><td><strong>Argo CD</strong></td><td>A robot that watches Git and makes Kubernetes match it.</td><td>Manual <code>kubectl apply</code> is now a pull-request review.</td></tr>
        <tr><td><strong>Kubernetes</strong></td><td>The planet-scale scheduler that keeps those containers healthy.</td><td>Auto-heals, scales, and rolls out with zero downtime.</td></tr>
        <tr><td><strong>DSPy</strong></td><td>Prompt-engineering as typed, testable code.</td><td>Turns LLM prompts into reproducible pipelines.</td></tr>
        <tr><td><strong>OPA / Kyverno</strong></td><td>Policy-as-code gatekeepers for every API call.</td><td>Blocks <code>:latest</code> images or unencrypted buckets before they deploy.</td></tr>
      </tbody>
    </table>
  </section>

  <hr>

  <h2>4. How the Characters relate to Each Other</h2>
  <p>Table: A Declarative Software Architecture Workflow</p>

  <!--  SVG: zoomable without JS  -->
  <svg class="infra-svg" viewBox="0 0 2472 872" preserveAspectRatio="xMidYMid meet"
       xmlns="http://www.w3.org/2000/svg" role="img" aria-labelledby="svgTitle">
    <title id="svgTitle">Declarative GitOps workflow from Git to running services</title>

    <!-- Gradient for node strokes -->
    <defs>
      <linearGradient id="grad" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%"  stop-color="#60a5fa"/>
        <stop offset="100%" stop-color="#00ff00"/>
      </linearGradient>
    </defs>

    <!-- ========== Nodes ========== -->
    <!-- Git -->
    <g id="git">
      <rect x="1979" y="8" width="232" height="66" rx="6" fill="#111827" stroke="url(#grad)" stroke-width="2"/>
      <text x="2095" y="41" text-anchor="middle" fill="#fff" font-size="14">Git Repository: single source of truth</text>
    </g>

    <!-- CI -->
    <g id="ci">
      <rect x="910" y="166" width="232" height="66" rx="6" fill="#111827" stroke="url(#grad)" stroke-width="2"/>
      <text x="1026" y="199" text-anchor="middle" fill="#fff" font-size="14">CI Pipeline: GitHub/GitLab Actions</text>
    </g>

    <!-- Argo CD -->
    <g id="argocd">
      <rect x="910" y="324" width="232" height="66" rx="6" fill="#111827" stroke="url(#grad)" stroke-width="2"/>
      <text x="1026" y="357" text-anchor="middle" fill="#fff" font-size="14">Argo CD: Declarative Continuous Delivery</text>
    </g>

    <!-- K8s -->
    <g id="k8s">
      <rect x="641" y="482" width="232" height="66" rx="6" fill="#111827" stroke="url(#grad)" stroke-width="2"/>
      <text x="757" y="515" text-anchor="middle" fill="#fff" font-size="14">Kubernetes Cluster: NixOS nodes</text>
    </g>

    <!-- Observability -->
    <g id="obs">
      <rect x="257" y="640" width="232" height="66" rx="6" fill="#111827" stroke="url(#grad)" stroke-width="2"/>
      <text x="373" y="673" text-anchor="middle" fill="#fff" font-size="14">Observability &amp; Policy</text>
    </g>

    <!-- ========== Edges ========== -->
    <defs>
      <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5"
              markerWidth="6" markerHeight="6" orient="auto">
        <path d="M0 0L10 5L0 10z" fill="#00ff00"/>
      </marker>
    </defs>

    <!-- Git → CI -->
    <path d="M1979 41L1026 120" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>
    <text x="1502" y="85" fill="#fff" font-size="12" text-anchor="middle">Pull-Request → Review → Merge</text>

    <!-- CI → Argo CD -->
    <path d="M1026 232L1026 324" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>
    <text x="1046" y="278" fill="#fff" font-size="12">Promotes validated artefacts</text>

    <!-- Argo CD → K8s -->
    <path d="M1026 390L757 482" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>
    <text x="891" y="445" fill="#fff" font-size="12">Kustomize/Helm manifests</text>

    <!-- K8s → Observability -->
    <path d="M641 548L373 640" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>

    <!-- Git → NixOS flake -->
    <path d="M1979 60L1301 120" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>
    <text x="1640" y="95" fill="#fff" font-size="12">NixOS host specs: flake.nix</text>

    <!-- Git → Terraform -->
    <path d="M1979 75L1559 120" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>
    <text x="1769" y="95" fill="#fff" font-size="12">Terraform infra: main.tf</text>

    <!-- Git → Dockerfile -->
    <path d="M1982 90L1823 120" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>
    <text x="1902" y="105" fill="#fff" font-size="12">Dockerfiles &amp; image lockfiles</text>

    <!-- Git → Argo Apps -->
    <path d="M2100 90L2105 120" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>
    <text x="2105" y="105" fill="#fff" font-size="12">Argo CD Apps &amp; Projects: YAML</text>

    <!-- Git → DSPy -->
    <path d="M2209 90L2367 120" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>
    <text x="2288" y="105" fill="#fff" font-size="12">DSPy pipelines: Python</text>

    <!-- Argo CD → Namespaces -->
    <path d="M984 423L984 482" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>
    <text x="1004" y="452" fill="#fff" font-size="11">Namespace A</text>

    <path d="M1204 423L1204 482" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>
    <text x="1224" y="452" fill="#fff" font-size="11">Namespace B</text>

    <path d="M1424 423L1424 482" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>
    <text x="1444" y="452" fill="#fff" font-size="11">Namespace C</text>

    <!-- K8s → infra add-ons -->
    <path d="M631 548L631 640" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>
    <text x="541" y="594" fill="#fff" font-size="11">MetalLB / Cilium / cert-manager</text>

    <path d="M908 548L908 640" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>
    <text x="818" y="594" fill="#fff" font-size="11">External-DNS / CSI storage</text>

    <path d="M1141 548L1141 640" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>
    <text x="1051" y="594" fill="#fff" font-size="11">HPA / VPA / PDB</text>

    <path d="M1379 548L1379 640" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>
    <text x="1289" y="594" fill="#fff" font-size="11">PodSecurityPolicies / OPA Gatekeeper</text>

    <path d="M1616 548L1616 640" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>
    <text x="1526" y="594" fill="#fff" font-size="11">DSPy Jobs: Cron</text>

    <path d="M1804 548L1804 640" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>
    <text x="1714" y="594" fill="#fff" font-size="11">Game Services</text>

    <!-- Observability → deeper tooling -->
    <path d="M124 708L124 800" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>
    <text x="80" y="754" fill="#fff" font-size="11">Prometheus → Grafana</text>

    <path d="M375 708L375 800" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>
    <text x="331" y="754" fill="#fff" font-size="11">Loki / Tempo traces</text>

    <path d="M622 708L622 800" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>
    <text x="578" y="754" fill="#fff" font-size="11">Alertmanager → PagerDuty</text>

    <path d="M899 708L899 800" stroke="#00ff00" stroke-width="2"
          marker-end="url(#arrow)"/>
    <text x="855" y="754" fill="#fff" font-size="11">Policy-as-code: OPA / Kyverno</text>
  </svg>

  <hr>

  <h2>5. A Day in the Life of a Change</h2>
  <p>Let’s add a new feature: “Show real-time in-game leaderboards”.</p>
  <ol>
    <li><strong>Code</strong>
      <ul>
        <li>Write the leaderboard service in Go.</li>
        <li>Add a DSPy pipeline to pre-aggregate stats.</li>
        <li>Commit everything to git.</li>
      </ul>
    </li>
    <li><strong>CI Gate</strong>
      <ul>
        <li>Nix builds the Docker image (bit-for-bit reproducible).</li>
        <li>Terraform dry-run shows a new Redis cache.</li>
        <li>Tests pass → image is signed &amp; pushed.</li>
      </ul>
    </li>
    <li><strong>GitOps Sync</strong>
      <ul>
        <li>Argo CD detects the new commit hash.</li>
        <li>Kubernetes manifests are applied; pods roll out blue-green.</li>
        <li>OPA policy ensures the service can’t talk to the payments DB.</li>
      </ul>
    </li>
    <li><strong>Observe</strong>
      <ul>
        <li>Prometheus sees p95 latency drop.</li>
        <li>Grafana dashboard auto-updates.</li>
        <li>No humans touched a server.</li>
      </ul>
    </li>
  </ol>

  <hr>

  <h2>6. Beginner Take-aways</h2>
  <ul>
    <li><strong>Start small:</strong> Put one service in Docker, store its manifest in Git, and let Argo CD sync it.</li>
    <li><strong>Lean on NixOS for dev laptops</strong> – <code>nix develop</code> gives the exact same tools as prod.</li>
    <li><strong>Policies early:</strong> A 15-line OPA rule today prevents a 3 a.m. breach tomorrow.</li>
    <li><strong>Celebrate merges:</strong> Every green PR is a fully tested, policy-compliant, zero-downtime release.</li>
  </ul>

  <section id="stack-assets">
    <h3>Grab the configs</h3>
    <button id="copyBtn">📋 Copy URLs</button>
    <p>Everything below is ready to copy-paste from <code>assets/</code>.</p>
    <ol>
      <li><a href="assets/README.md" download>README.md</a> — full walk-through &amp; quick-start guide.</li>
      <li><a href="assets/flake.nix" download>flake.nix</a> — NixOS dev-shell with pinned Terraform, kubectl, Argo CD CLI, Docker.</li>
      <li><a href="assets/main.tf" download>main.tf</a> — Terraform plan to spin up an EKS cluster (swap provider blocks for GCP/Azure).</li>
      <li><a href="assets/argocd-app.yaml" download>argocd-app.yaml</a> — Argo CD Application that bootstraps Gatekeeper in <code>gatekeeper-system</code>.</li>
      <li><a href="assets/constraint-template.yaml" download>constraint-template.yaml</a> — OPA Gatekeeper template that rejects any container image tagged <code>:latest</code>.</li>
    </ol>
  </section>

  <hr>

  <h2>7. The Bigger Picture</h2>
  <p>Declarative, Git-driven stacks aren’t tools; they’re a culture.<br>
     When everything is code, knowledge lives in the repo, not in someone’s head.<br>
     That means faster onboarding, fearless refactors, and—best of all—Friday deploys that don’t ruin weekends.</p>
  <p><strong>Welcome to the Declared World:</strong> where the robots do the toil, and we get back to building great games.</p>

  <hr>
  <p style="font-size:.9em;color:#9ca3af;">© 2025 Jonathan McGuinness</p>

  <!-- tiny inline script only for the copy button – no impact on SVG -->
  <script>
    document.getElementById('copyBtn').addEventListener('click', () => {
      const urls = Array.from(document.querySelectorAll('#stack-assets a'))
                       .map(a => a.href).join('\n');
      navigator.clipboard.writeText(urls).then(() => {
        const btn = document.getElementById('copyBtn');
        btn.textContent = '✅ Copied!';
        setTimeout(() => btn.textContent = '📋 Copy URLs', 1500);
      });
    });
  </script>
</body>
</html>
